---
title: "Tables and Figures for _Trends in Higher Ed Protest_"
output:
  github_document: 
    toc: true
---

```{r setup, include=FALSE, message=FALSE}
library(targets)
library(knitr)
library(sf)
library(showtext)
library(tidyverse)
library(writexl)
library(nplyr)

opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
opts_chunk$set(echo = FALSE, warning = FALSE, fig.width = 10, fig.height = 7)

font_add_google("Lato")
showtext_auto()

custom_theme <- function(...){
  theme_bw() + 
    theme(
      text = element_text(family = "Lato", size = 14),
      ...
    )
}

theme_set(custom_theme())
country_scale <- c(
  "US" = "#377EB8",
  "Canada" = "#E41A1C"
)
```

```{r}
# During interactive use, this chunk has to be loaded separately from the setup chunk.
# `targets` looks for a `_targets/` directory but cannot find one
# if the working directory is pointed at the `docs/` directory already, as is the
# case with Rmarkdown documents by default.

# The line starting with `opts_knit$set` above sets the correct working directory,
# but it only applies for chunks after the setup chunk, hence the separation of 
# the data load and the rest of the setup

# This is quite annoying workflow-wise, as the setup chunk is loaded automatically
# but this chunk isn't
mpeds_raw <- tar_read(canonical_events)
mpeds_sf <- tar_read(integrated) 
mpeds <- mpeds_sf |>
  st_drop_geometry() |> 
  mutate(country = if_else(str_extract(geoid, "us|canada") == "us", "US", "Canada") |> 
           fct_relevel("US", "Canada")
           )
relationships <- tar_read(canonical_event_relationship)

uni_country <- bind_rows(
  "US" = tar_read(ipeds),
  "Canada" = tar_read(glued),
  .id = "country"
) |> 
  select(country, uni_id) |> 
  distinct()

mpeds <- mpeds |> 
  nest_left_join(university, uni_country, by = "uni_id") |> 
  mutate(country = map_chr(university, \(uni_dta){
      if(nrow(uni_dta) == 0){
        return(NA_character_)
      }
      if(nrow(drop_na(uni_dta, uni_id)) == 0){
        return(NA_character_)
      }
      
      # For each event, look through the university dataframe and pick a university
      # prioritizing "other univ where protest occurs" and then "publication" if it's available
      row <- uni_dta |> 
        filter(!is.na(uni_id)) |> 
        mutate(uni_name_source = factor(uni_name_source, levels = c(
          "other univ where protest occurs", "publication"
          ))) |>
        arrange(uni_name_source) |>
        slice_head(n = 1)
      
      # Then return the corresponding country
      row$country
    }), 
    country_geo = if_else(str_extract(geoid, "us|canada") == "us", "US", "Canada"),
    country = if_else(is.na(country), country_geo, country)) 

racial_issues <- read_csv("tasks/university_covariates/hand/racial_issues.csv",
                          show_col_types = FALSE)

```

# Figure 1: Frequency of U.S. and Canadian higher ed protest events, Jan. 2012 - July 2018

```{r}
protests_by_country <- mpeds |> 
  filter(start_date >= as.Date("2012-01-01"),
         start_date <= as.Date("2018-07-31"),
         !(country == "Canada" & start_date > as.Date("2018-06-30"))) |> 
  mutate(date = floor_date(start_date, "month")) |> 
  group_by(country, date) |> 
  count() |> 
  drop_na() 

breaks <- seq.Date(from = as.Date("2011-10-01"),
                   to = as.Date("2018-04-01"),
                   by = "6 months")

ggplot(protests_by_country, aes(fill = country, x = date, y = n)) + 
  geom_bar(stat = "identity") + 
  scale_fill_manual(values = country_scale) + 
  scale_x_date(date_labels = "%b '%y",
               breaks = breaks,
               expand = c(0, 0),
               limits = c(as.Date("2012-01-01"), as.Date("2018-07-31")),
               guide = guide_axis(n.dodge = 2)) + 
  labs(
    y = "Number of associated protests",
    x = NULL,
    fill = NULL,
    title = "Frequency of U.S. and Canadian higher ed protest events, Jan. 2012 - July 2018"
  ) + 
  theme(legend.position = "bottom")

```

# Figure 2: Frequency of U.S. higher ed protest events and major waves, Jan. 2012 - July 2018

```{r us_over_time, width = 12, height = 8}

summer_color <- "#ff4b3a"
events_color <- "#2133ff"

summers <- tibble(
  x1 = seq(as.Date("2012-06-01"), as.Date("2018-06-01"), by = "1 year"),
  x2 = seq(as.Date("2012-08-31"), as.Date("2018-08-31"), by = "1 year"),
  y1 = -100,
  y2 = Inf
)

events <- tribble(
  ~date, ~x_offset, ~text, ~country, ~height, ~filter,
  "2012-02-01", 200, "Quebec tuition\nprotests", "Canada", 90, \(dta){
    dta |> 
      filter(map_lgl(issue, ~any(str_detect(., "Tuition"))),
             str_detect(location, "QC, Canada"))
  },
  "2014-11-01", 250, "Toronto labor\nprotests", "Canada", 80, \(dta){
    dta |> 
      filter(map_lgl(issue, ~any(str_detect(., "Labor"))),
             str_detect(location, "Toronto"))
  },
  "2014-11-01", -180, "Protests against\nracist policing", "US", 225, \(dta){
    dta |> 
      filter(map_lgl(issue, ~any(str_detect(., "Police violence"))))
  },
  "2015-10-01", -90, "Mizzou\nprotests", "US", 225, \(dta){
    dta |> 
      filter(canonical_id %in% mizzou_events)
  },
  "2016-11-01", -150,"Anti-Trump\nprotests", "US", 350, \(dta){
    dta |> 
      filter(map_lgl(issue, ~any(str_detect(., "Trump"))))
  }
) |> 
  mutate(date = as.Date(date))


make_plot <- function(country_opt){
  dta <- protests_by_country |> 
    filter(country == country_opt)
  country_events <- events |>
    filter(country == country_opt)
  
  ggplot(data = dta, aes(x = date, y = n)) + 
    geom_line(color = country_scale[country_opt]) + 
    geom_label(data = country_events, 
               aes(x = date + x_offset, y = height, label = text),
               color = country_scale[country_opt]) + 
    scale_y_continuous(breaks = \(x){seq(0, max(x), by = 50)},
                       limits = c(0, max(dta$n, country_events$height, na.rm = T) + 30),
                       expand = c(0, 0)) + 
    scale_x_date(breaks = breaks,
                 date_labels = "%b '%y",
                 expand = c(0, 0),
                 guide = guide_axis(n.dodge = 2)) + 
      
    labs(
      title = paste0("Counts of protests in ", country_opt, " over time"),
      x = NULL,
      y = "Number of associated events",
    ) 
}

make_plot("US")
```

# Figure 3. Frequency of Canadian higher ed protest events and major waves, Jan. 2012 - Dec. 2018

```{r canada_over_time, width = 12, height = 8}
make_plot("Canada")
```

# Table 1: Top 10 U.S. and Canadian universities and locations for higher ed protests

```{r}
university_counts <- mpeds |> 
  pull(university) |> 
  bind_rows() |> 
  group_by(uni_name) |> 
  count(name = "university_n") |> 
  ungroup() |> 
  drop_na() |>
  slice_max(order_by = university_n, n = 15)

location_counts <- mpeds |> 
  group_by(location) |> 
  count(name = "location_n") |> 
  ungroup() |> 
  drop_na() |> 
  slice_max(order_by = location_n, n = 15, with_ties = FALSE)

bind_cols(university_counts, location_counts) |> 
  kable()
```

# Table 2: Top 15 U.S. Higher Ed Protest Issues

```{r}

make_issue_counts <- function(country_opt, sub_dta = NULL){
  if(is.null(sub_dta)){
    sub_dta <- mpeds
  }
  country <- sub_dta |> 
    filter(country == country_opt)
  
  total_n <- country |> 
    filter(!str_detect(tolower(key), "umbrella")) |> 
    pull(key) |> 
    unique() |> 
    length()
  
  raw_key <- country |> 
    select(key, issue, racial_issue) |> 
    pivot_longer(cols = c(everything(), -key)) |> 
    unnest(value) |> 
    filter(value != "_Not relevant", value != "",
           value != "Anti-racism")
  
  raw <- raw_key |> 
    group_by(value, name) |> 
    summarize(n = n(),
              lst = list(key), .groups = "drop")
  
  bucket_counts <- racial_issues |> 
    left_join(raw_key, by = c("issue" = "value")) |> 
    select(bucket, key) |> 
    distinct() |> 
    group_by(value = bucket) |> 
    summarize(total_n = n(), .groups = "drop")
  
  with_buckets <- bucket_counts |> 
    rename(n = total_n) |> 
    mutate(value = paste0("All ", value) |> str_to_sentence()) |> 
    bind_rows(raw) |> 
    mutate(name = ifelse(is.na(name), "total", name)) |> 
    arrange(desc(n)) 
  
  formatted <- with_buckets |> 
    pivot_wider(names_from = name, values_from = c(n, lst)) |> 
    mutate(
      is_racist = value == "All racist issues"
    ) |> 
    slice_max(tibble(is_racist, n_total), n = 15, with_ties = FALSE) |> 
    mutate(
      total_candidate = map2_dbl(
        lst_issue, lst_racial_issue,
        \(issue, racial_issue){
          length(unique(c(issue, racial_issue)))
        }
      ),
      total = ifelse(is.na(n_total), total_candidate, n_total)) |> 
    arrange(desc(total)) |> 
    mutate(across(where(is.numeric), ~ifelse(
          is.na(.), "", paste0(
            round(100 * ./total_n, 2), "% (", format(., big.mark = ",") |> 
              str_trim(), ")")
          )
    )) |> 
    select(issue_name = value, 
           total,
           `non-racial` = n_issue,
           racial = n_racial_issue) 
  
  return(lst(raw, formatted))
}

make_issue_counts("US")$formatted |> 
  kable()

```

# Table 3: Top 15 U.S. Higher Ed Protest Issues with University as the Target

```{r}
make_issue_counts(
  "US", mpeds |> filter(map_lgl(target, ~"University/school" %in% .))
)$formatted |> 
  kable()

```

# Table x: Top 15 Canadian Higher Ed Protest Issues

```{r}

get_canada_issue_counts <- function(dta){
  canada <- dta |> 
    filter(country == "Canada", !str_detect(key, "Umbrella"))
  canada_racial <- canada |> 
    filter(map_lgl(racial_issue, ~!all(. == "_Not relevant"))) |> 
    nrow()
  
  canada_issue <- canada |> 
    select(issue) |> 
    unnest(issue) |> 
    filter(issue != "_Not relevant") |> 
    count(issue) |> 
    bind_rows(tibble(issue = "Any racial issue", n = canada_racial)) |> 
    arrange(desc(n)) |> 
    mutate(n = ifelse(
      is.na(n), "", paste0(round(100 * n/nrow(canada), 2), "% (", n, ")"))
    )
  return(canada_issue)
}


make_issue_counts("Canada")$formatted |> 
  kable()

```

# Table x. Top 10 Canadian Higher Ed Protest Issues with University as the Target

```{r}

mpeds |> 
  filter(map_lgl(target, ~"University/school" %in% .)) |> 
  get_canada_issue_counts() |> 
  head(10) |> 
  kable()

```

# NEW TABLES BELOW THIS POINT

# Table x. Top 10 U.S. Higher Ed Protest Issues by year

```{r, message=FALSE}
make_issue_counts_by_year <- function(country_opt, sub_dta = NULL) {
  if(is.null(sub_dta)){
    sub_dta <- mpeds
  }
  
  country <- sub_dta |> 
    filter(country == country_opt)
  
  total_n <- country |> 
    filter(!str_detect(tolower(key), "umbrella")) |> 
    pull(key) |> 
    unique() |> 
    length()
  
  dates <- country |> 
    select(canonical_id, key, start_date, end_date) |> 
    filter(!str_detect(start_date, "2011")|!str_detect(end_date, "2011")) |>
    mutate(year = format(start_date, "%Y")) |> 
    group_by(year) |> 
    summarise("number_of_protests" = sum(length(unique(key))))
  
  country <- country |> 
    mutate(year = year(start_date))
    
  issues_values <- country |> 
    select(key, issue, racial_issue, year) |> 
    pivot_longer(cols = c(everything(), -key, -year)) |> 
    unnest(value) |> 
    filter(value != "_Not relevant", value != "",
           value != "Anti-racism")
  
  top_issues <- issues_values |> 
    group_by(value, name) |> 
    summarize(n = n(),
              lst = list(key), .groups = "drop") |> 
    ungroup() |> 
    drop_na() |> 
    slice_max(order_by = n, n = 10, with_ties = FALSE) |> 
    select(!lst)
  
  issue_count_by_year <- issues_values |>  
    right_join(top_issues, by = c("name", "value")) |> 
    group_by(year, issue = value, type = name, total_n = n) |> 
    summarize(n = n())  |> 
    ungroup() |> 
    pivot_wider(names_from = "year",
                values_from = "n") |> 
    select(-"2011") |> 
    arrange(desc(total_n)) 
  
  return(issue_count_by_year)
}
  
  # running same analysis using end_date, just to check
  # country$end_date <- as.Date(country$end_date)
  # 
  # end_dates <-country |> 
  #   select(canonical_id, key, start_date, end_date) |> 
  #   filter(!str_detect(start_date, "2011")|!str_detect(end_date, "2011")) |>
  #   mutate(year = format(end_date, "%Y")) |> 
  #   group_by(year) |> 
  #   summarise("number_of_protests" = sum(length(unique(key))))
  

  make_issue_counts_by_year("US") |> 
    kable()
  
  
  # ISSUES BY MONTH -- should probably just make it all one function with
  # interval parameter instead. will correct in the future
  
  make_issue_counts_by_month <- function(country_opt, sub_dta = NULL) {
  if(is.null(sub_dta)){
    sub_dta <- mpeds
  }
  
  country <- sub_dta |> 
    filter(country == country_opt)
  
  #DELETE THIS LINE
  country <- mpeds  #DELETE THIS LINE
  
  total_n <- country |> 
    filter(!str_detect(tolower(key), "umbrella")) |> 
    pull(key) |> 
    unique() |> 
    length()
  
  dates <- country |> 
    select(canonical_id, key, start_date, end_date) |> 
    filter(!str_detect(start_date, "2011")|!str_detect(end_date, "2011")) |>
    mutate(month_year = format(start_date, "%Y-%m")) |> 
    group_by(month_year) |> 
    summarise("number_of_protests" = sum(length(unique(key))))
  
  country <- country |> 
    mutate(year = year(start_date)) |> 
    mutate(month_year = format(start_date, "%Y-%m"))
    
  issues_values <- country |> 
    select(key, issue, racial_issue, month_year) |> 
    pivot_longer(cols = c(everything(), -key, -month_year)) |> 
    unnest(value) |> 
    filter(value != "_Not relevant", value != "",
           value != "Anti-racism")
  
  top_issues <- issues_values |> 
    group_by(value, name) |> 
    summarize(n = n(),
              lst = list(key), .groups = "drop") |> 
    ungroup() |> 
    drop_na() |> 
    slice_max(order_by = n, n = 10, with_ties = FALSE) |> 
    select(!lst)
  
  issue_count_by_month <- issues_values |>  
    right_join(top_issues, by = c("name", "value")) |> 
    group_by(month_year, issue = value, type = name, total_n = n) |> 
    summarize(n = n())  |> 
    ungroup() |> 
    pivot_wider(names_from = "month_year",
                values_from = "n") |> 
    select(!starts_with("2011")) |> 
    arrange(desc(total_n)) 
  
  return(issue_count_by_month)
  
  }
  
```
  
# Table x. Top 10 U.S. Higher Ed Protest Issues by month
```{r, message=FALSE}  
  make_issue_counts_by_month("US") |> 
    kable()
```

# Table x. Top 10 Canada Higher Ed Protest Issues by year
```{r, message=FALSE}
 make_issue_counts_by_year("Canada") |> 
    kable()

```

# Table x. Top 10 Canada Higher Ed Protest Issues by month
```{r, message=FALSE}
 make_issue_counts_by_month("Canada") |> 
    kable()

```


# U.S. Waves Count

## First Wave - BLM 2014
```{r}
us_protests <- mpeds |> 
  filter(country == "US")

us_protests_issues <- us_protests |> 
  select(canonical_id, key, start_date, issue, racial_issue) |> 
  unnest(issue) |> 
  unnest(racial_issue)

blm_wave <- us_protests_issues |> 
  select(-issue) |> 
  filter(racial_issue == "Police violence") |> 
  filter(start_date >= as.Date("2014-11-20") & 
         start_date <= as.Date("2014-12-15"))

 make_weekly_count <- function(issue_df) {
   first_protest_date <- min(issue_df$start_date) #get first protest in the wave
   last_protest_date <- max(issue_df$start_date) #get last protest in the wave
   
   #create a week by week sequence of the wave, ranging from first to last protest
   all_weeks <- seq(floor_date(first_protest_date, "week"), 
                    floor_date(last_protest_date, "week"), 
                    by = "week") 
 
   weekly_count <- issue_df |> 
   mutate(week_start = floor_date(start_date, "week")) |> 
   group_by(week_start) |> 
   summarize(n = n()) |> 
   complete(week_start = all_weeks, fill = list(n=0)) |> 
   arrange(week_start) 
   
   return(weekly_count)
 }
 
 first_us_wave_summary <- tibble(
   wave = "BLM wave",
   n_protests = nrow(blm_wave) 
   )
   
 first_us_wave_weekly_count <- make_weekly_count(blm_wave)
 
  writexl::write_xlsx(lst(first_us_wave_summary, 
                         first_us_wave_weekly_count),
                      "docs/trends-paper/wave-counts/us-wave-counts/first_us_wave_counts.xlsx")
 
```

## Second Wave - Mizzou
```{r}

  source("tasks/one-off/get_any_umbrella.R")
  mizzou_umbrella <- get_any_umbrella("Umbrella_Mizzou_Anti-Racism_2015-2016_Oct-Feb")
  
  mizzou_umbrella_weekly_count <- make_weekly_count(mizzou_umbrella)
  
  # racial_issue == univ admin
  univ_admin_and_campus_climate <- us_protests_issues |> 
    filter(racial_issue == "University governance, admin, policies, programs, curriculum" |
           racial_issue == "Campus climate")
  
  univ_admin_and_campus_climate_weekly_count <- make_weekly_count(univ_admin_and_campus_climate)
  
  second_us_wave_summary <- tibble(
   criteria = c("Mizzou umbrella", "racial_issue == Univ governance... OR racial_issue == Campus climate"),
   n_protests = c(nrow(mizzou_umbrella), nrow(univ_admin_and_campus_climate))
  )
  
  writexl::write_xlsx(lst(second_us_wave_summary, 
                         univ_admin_and_campus_climate_weekly_count),
                      "docs/trends-paper/wave-counts/us-wave-counts/second_us_wave_counts.xlsx")

```

## Third Wave - Trump
```{r}

 # issue == trump, racial_issue != immigration
 trump_not_immigration <- us_protests_issues |> 
   filter(str_detect(tolower(issue),"trump")) |> 
   filter(!str_detect(tolower(racial_issue), "immigration"))
 
 # issue != trump, racial_issue == immigration
 immigration_not_trump <- us_protests_issues |>
   filter(str_detect(tolower(racial_issue), "immigration")) |> 
   filter(!str_detect(tolower(issue),"trump")) 
 
 # issue = trump, issue = immigration
 trump_and_immigration <- us_protests_issues |> 
   filter(str_detect(tolower(issue),"trump")) |> 
   filter(str_detect(tolower(racial_issue), "immigration"))
 
 third_us_wave_counts <- c(nrow(trump_not_immigration), 
                           nrow(immigration_not_trump), 
                           nrow(trump_and_immigration))
 
 third_us_wave_summary <- tibble(
   issue = c("trump_not_immigration", "immigration_not_trump", "trump_and_immigration"),
   n_protests = c(third_us_wave_counts)
 )


 trump_not_immigration_weekly_count <- make_weekly_count(trump_not_immigration)
 immigration_not_trump_weekly_count <- make_weekly_count(immigration_not_trump)
 trump_and_immigration_weekly_count <- make_weekly_count(trump_and_immigration)
 
 writexl::write_xlsx(lst(third_us_wave_summary, 
                         trump_not_immigration_weekly_count,
                         immigration_not_trump_weekly_count,
                         trump_and_immigration_weekly_count),
                      "docs/trends-paper/wave-counts/us-wave-counts/third_us_wave_counts.xlsx")
```

## US Waves Summary
```{r}

us_waves_summary <- tibble(
  wave = c("first wave", "second wave (mizzou umbrella count)", "third wave (trump AND immigration count)"),
  n_protests = c(nrow(blm_wave), nrow(mizzou_umbrella), nrow(trump_and_immigration))
)

writexl::write_xlsx(us_waves_summary,
                      "docs/trends-paper/wave-counts/us-wave-counts/us_waves_summary.xlsx")
```

# Canada Waves Count

## First Wave - Quebec 2012
```{r}
  canada_protests <- mpeds |> 
    filter(country == "Canada")
  
  canada_protests_issues <- canada_protests |> 
    select(canonical_id, key, location, start_date, issue, racial_issue) |> 
    unnest(issue) |> 
    unnest(racial_issue) 
  
  quebec_protests <- canada_protests_issues |>
    filter(str_detect(location,"QC"))  
    
  quebec_tuition_protests <- quebec_protests |> 
    filter(issue == "Tuition, fees, financial aid") |> 
    filter(str_detect(start_date, "2012-"))
    
  quebec_police_violence_protests <- quebec_protests |> 
    filter(issue == "Police violence/anti-law enforcement/criminal justice") |> 
    filter(str_detect(start_date, "2012-"))
  
  quebec_tuition_weekly_count <- make_weekly_count(quebec_tuition_protests)
  quebec_police_violence_protests_weekly_count <- make_weekly_count(quebec_police_violence_protests)

  first_canada_wave_summary <- tibble(
     issue = c("Quebec Tuition Protests in 2012", "Quebec Police Violence Protests in 2012"),
     n_protests = c(nrow(quebec_tuition_protests), nrow(quebec_police_violence_protests)) 
     )
  
  writexl::write_xlsx(lst(first_canada_wave_summary, 
                         quebec_tuition_weekly_count, 
                         quebec_police_violence_protests_weekly_count),
                      "docs/trends-paper/wave-counts/canada-wave-counts/first_canada_wave_counts.xlsx")

```

## Second Wave - Toronto Labor
```{r}
  
  toronto_protests <- canada_protests_issues |>
      filter(str_detect(location,"Toronto"))  
  
  toronto_labor_protests <- toronto_protests |> 
      filter(issue == "Labor and work") |> 
      filter(str_detect(start_date, "2015-") | str_detect(start_date, "2014-"))
  
  toronto_labor_weekly_count <- make_weekly_count(toronto_labor_protests)
  
  quebec_labor_protests <- quebec_protests |> 
      filter(issue == "Labor and work") |> 
      filter(str_detect(start_date, "2015-") | str_detect(start_date, "2014-"))
  
  quebec_labor_weekly_count <- make_weekly_count(quebec_labor_protests)

  second_canada_wave_summary <- tibble(
     criteria = c("Toronto Labor Protests 2014/2015", "Quebec Labor Protests 2014/2015"),
     n_protests = c(nrow(toronto_labor_protests), nrow(quebec_labor_protests)) 
     )
  
  writexl::write_xlsx(lst(second_canada_wave_summary, 
                         toronto_labor_weekly_count, 
                         quebec_labor_weekly_count),
                      "docs/trends-paper/wave-counts/canada-wave-counts/second_canada_wave_counts.xlsx")

```

# Statistics for in-text citations

## Country-level counts

```{r}
# canonical_id2 = campaign marker
campaigns <- relationships |> 
  filter(relationship_type == "campaign") |> 
  select(campaign_id = canonical_id2, event_id = canonical_id1)

make_stats <- function(dta){
  dta <- dta |> filter(!str_detect(key, "Umbrella"))
  n_protests <- length(unique(dta$key))
  n_locations <- length(unique(dta$location))
  n_universities <- dta$university |>
    bind_rows()  |>
    filter(uni_name_source %in% c(
      "publication", "participating_universities_text"
      )) |>
    select(uni_id) |>
    distinct() |>
    nrow()
  
  n_offcampus <- sum(dta$off_campus)
  n_counterprotest_checkbox <- sum(dta$counterprotest)
  n_multiplecities <- sum(dta$multiple_cities)
  
  # How many campaigns had an event that took place in this country
  n_campaigns <- dta |> 
    mutate(canonical_id = as.numeric(canonical_id)) |> 
    select(canonical_id) |> 
    inner_join(campaigns, by = c("canonical_id" = "event_id")) |> 
    pull(campaign_id) |> 
    unique() |> 
    length()
  
  n_oneform <- map_lgl(dta$form, ~length(.) == 1) |> sum()
  n_multipleform <- map_lgl(dta$form, ~length(.) > 1) |> sum()
  
  n_target_uni <- map_lgl(dta$target, ~any(. == "University/school")) |> sum()
  n_target_domestic_gov <- map_lgl(
    dta$target, ~any(. == "Domestic government")) |> sum()
  n_target_domestic_uni <- map_lgl(dta$target, ~(
    any(. == "Domestic government") & any(. == "University/school"))) |> 
    sum()
  
  stats <- tribble(
    ~statistic, ~value,
    "Protests", n_protests,
    "Locations", n_locations,
    "Universities", n_universities,
    "Off-campus protests", n_offcampus,
    "Counterprotest (via checkbox)", n_counterprotest_checkbox,
    "Protests in multiple cities", n_multiplecities,
    "Campaigns", n_campaigns,
    "Events with one form", n_oneform,
    "Events with multiple forms", n_multipleform,
    "# for Target = University", n_target_uni,
    "Target = Domestic government", n_target_domestic_gov,
    "Target = Domestic gov. + University", n_target_domestic_uni
  ) 
  
  return(stats)
}

bind_rows(
  make_stats(mpeds) |> mutate(country = "Both"), 
  make_stats(mpeds |> filter(country == "US")) |> mutate(country = "US"),
  make_stats(mpeds |> filter(country == "Canada")) |> mutate(country = "Canada")
) |> 
  pivot_wider(names_from = country) |> 
  kable()

```

## Wave-specific counts

```{r}
mizzou_events <- relationships |> 
  filter(canonical_id2 == 26,
         relationship_type != "counterprotest") |> 
  pull(canonical_id1)

event_counts <- events |> 
  mutate(count = map2_dbl(date, filter, \(date, event_filter){
    mpeds |> 
      event_filter() |> 
      filter(start_date <= date + 7,
             start_date >= date - 7,
             !str_detect(key, "Umbrella")) |> 
      nrow()
  }))

```

```{r export_sheets}
make_issue_counts("US") |>
  writexl::write_xlsx("docs/trends-paper/us_issues.xlsx")

get_canada_issue_counts(mpeds) |>
  writexl::write_xlsx("docs/trends-paper/canada_issues.xlsx")

```
